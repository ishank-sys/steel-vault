generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model Client {
  id               Int           @id @default(autoincrement())
  name             String
  email            String?       @unique
  contactNo        String?
  address          String?
  dbUrl            String?       @map("DB_URL")
  configuration    Json          @default("{}")
  ccListData       Json          @default("[]")
  folderStructure  Json          @default("{}")
  totalProjects    Int           @default(0)
  activeProjects   Int           @default(0)
  completedProjects Int          @default(0)
  totalProjectValue Decimal?     @db.Decimal(15,2)
  totalWeightage   Decimal?      @db.Decimal(10,2)
  lastActivityDate DateTime?
  attachments      Json?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  documentLogs     DocumentLog[]
  projects         Project[]     @relation("ClientProjects")
  users            User[]        @relation("ClientUsers")
  projectDrawings  ProjectDrawing[]
}

model User {
  id            Int       @id @default(autoincrement())
  name          String
  email         String
  password      String
  userType      String
  clientId      Int?
  contactNo     String?
  address       String?
  gender        String?
  teaminfo      Json?
  createdAt     DateTime  @default(now())
  relievedDate  DateTime?
  solTLProjects Project[] @relation("UserSolTL")
  client        Client?   @relation("ClientUsers", fields: [clientId], references: [id])
}

model Project {
  id                 BigInt    @id @default(autoincrement())
  projectNo          String    @map("ClientprojectNo")
  solProjectNo       String
  name               String
  description        String?
  clientId           Int
  solTLId            Int?      // Team Lead assignment
  status             String    @default("PLANNING")
  priority           String    @default("MEDIUM")
  progress           Decimal   @default(0.0) @db.Decimal(5,2)
  branch             String?
  startDate          DateTime?
  endDate            DateTime?
  expectedCompletion DateTime?
  totalDays          Int?
  estimationDate     DateTime?
  totalProjectHours  String?
  actualProjectHours String?
  totalSheetQty      String?
  weightTonnage      String?
  projectComplexity  String?
  solJobNo           String?
  projectType        String?
  projectSubType     String?
  projectDataFolder  String?
  jobName            String?
  estimationRows     Json      @default("[]")
  lastUpdated        DateTime  @updatedAt @default(now())
  lastActivityDate   DateTime?
  createdAt          DateTime  @default(now())
  documentLogs       DocumentLog[]
  projectDrawings    ProjectDrawing[]
  client             Client    @relation("ClientProjects", fields: [clientId], references: [id])
  solTL              User?     @relation("UserSolTL", fields: [solTLId], references: [id])
  clientPm           Int?
}

model DocumentLog {
  id           Int      @id @default(autoincrement())
  fileName     String
  clientId     Int
  projectId    BigInt
  storagePath  String
  size         Int
  uploadedAt   DateTime @default(now())
  logType      String?
  submittal    String?
  client       Client   @relation(fields: [clientId], references: [id])
  project      Project  @relation(fields: [projectId], references: [id])
}

// Stores the latest state of a project's drawing by DrgNo and optional category.
// Intended to be upserted on publish so UI can show current revision and attachment name.
model ProjectDrawing {
  id             BigInt    @id @default(autoincrement())
  projectId      BigInt
  packageId      BigInt?
  drawingNumber  String
  title          String?
  revision       String?
  issueDate      DateTime? @db.Date
  status         String?
  filePath       String?
  metadata       Json?
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @db.Timestamptz(6)
  category       String
  clientId       Int?
  item           String?
  fileName       String?
  lastAttachedAt DateTime?
  meta           Json?
  clientRowId    String?
  drgNo          String?
  serial_no      Int?
  description    String?
  assy_qty       Int?
  finish         String?
  date_sent_for_approval DateTime? @db.Date
  date_sent_for_fab_field DateTime? @db.Date
  remark         String?
  mod            String?
  det            String?
  chk            String?
  sheet_size     String?
  rev_remark     String?
  version        Int
  superseded_by  BigInt?
  lineage_key    String?

  client         Client?   @relation(fields: [clientId], references: [id])
  project        Project   @relation(fields: [projectId], references: [id])

  @@unique([projectId, drgNo, category])
}

model ProjectPackage {
  id            BigInt   @id @default(autoincrement())
  projectid     BigInt
  name          String
  packagenumber String?
  tentativedate DateTime? @db.Date
  ifadate       DateTime? @db.Date
  status        String?
  tasks         Json     @default("[]")
  notes         String?
  createdat     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  drawingCount  Int
  bfadate       DateTime? @db.Date
  ifcdate       DateTime? @db.Date
  ifaversion    String?
  ifcversion    String?
}

model ProjectRFI {
  id        BigInt   @id @default(autoincrement())
  projectid BigInt
  rfinumber String?
  date      DateTime? @db.Date
  status    String?
  remark    String?
  answer    String?
  answereddate DateTime? @db.Date
  attachments Json?
  createdat DateTime @default(now()) @db.Timestamptz(6)
  updatedat DateTime @updatedAt @db.Timestamptz(6)
}

// Background job queue table for DB-poller worker
model Job {
  id          Int      @id @default(autoincrement())
  type        String   // parse-excel | validate-conflicts | publish-job | generate-zip
  status      String   @default("queued") // queued | running | succeeded | failed
  payload     Json
  result      Json?
  progress    Int?     @default(0)
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}